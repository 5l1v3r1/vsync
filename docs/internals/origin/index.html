<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.58">
<title data-react-helmet="true">Origin | vsync</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Origin | vsync"><meta data-react-helmet="true" name="description" content="This is the start of unidirectional connection for syncing secrets. It should point to primary vault cluster from which users expect the secrets to be propagated to other vaults in different regions."><meta data-react-helmet="true" property="og:description" content="This is the start of unidirectional connection for syncing secrets. It should point to primary vault cluster from which users expect the secrets to be propagated to other vaults in different regions."><meta data-react-helmet="true" property="og:url" content="https://expediagroup.github.io/vsync/docs/internals/origin"><link data-react-helmet="true" rel="shortcut icon" href="/vsync/img/icon.png"><link data-react-helmet="true" rel="canonical" href="https://expediagroup.github.io/vsync/docs/internals/origin"><link rel="stylesheet" href="/vsync/styles.049f2491.css">
<link rel="preload" href="/vsync/styles.eea3d490.js" as="script">
<link rel="preload" href="/vsync/runtime~main.ef594e85.js" as="script">
<link rel="preload" href="/vsync/main.3dbd1806.js" as="script">
<link rel="preload" href="/vsync/1.1056e411.js" as="script">
<link rel="preload" href="/vsync/2.0b2ae9c7.js" as="script">
<link rel="preload" href="/vsync/19.2e660dd5.js" as="script">
<link rel="preload" href="/vsync/20.19d957be.js" as="script">
<link rel="preload" href="/vsync/9e5e1161.8c4f2118.js" as="script">
<link rel="preload" href="/vsync/17896441.f04f2844.js" as="script">
<link rel="preload" href="/vsync/e4a51ca5.a9da0374.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/vsync/"><img class="navbar__logo" src="/vsync/img/icon.png" alt="vsync logo"><strong class="navbar__title">Vsync</strong></a><a class="navbar__item navbar__link" href="/vsync/docs/getstarted/why">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ExpediaGroup/vsync" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/vsync/"><img class="navbar__logo" src="/vsync/img/icon.png" alt="vsync logo"><strong class="navbar__title">Vsync</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/vsync/docs/getstarted/why">Docs</a></li><li class="menu__list-item"><a href="https://github.com/ExpediaGroup/vsync" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp" role="complementary"><div class="sidebar_1kLs"><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">GetStarted</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/getstarted/why">Why</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/getstarted/install">Install</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/getstarted/config">Config</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Deploy</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/deploy/options">Options</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Internals</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/vsync/docs/internals/keywords">Keywords</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/vsync/docs/internals/origin">Origin</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/vsync/docs/internals/destination">Destination</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Faq</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/faq">Faq</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Contribution</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/contribution/build">Build</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/contribution/ci">CI</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/contribution/goodparts">Good Parts</a></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="container padding-vert--lg docItemWrapper_1cc7"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">Origin</h1></header><div class="markdown"><p>This is the start of unidirectional connection for syncing secrets. It should point to primary vault cluster from which users expect the secrets to be propagated to other vaults in different regions.</p><hr><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="startup"></a>Startup<a aria-hidden="true" tabindex="-1" class="hash-link" href="#startup" title="Direct link to heading">#</a></h2><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="step-1"></a>Step 1<a aria-hidden="true" tabindex="-1" class="hash-link" href="#step-1" title="Direct link to heading">#</a></h4><p>Get consul and vault clients pointing to origin</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="step-2"></a>Step 2<a aria-hidden="true" tabindex="-1" class="hash-link" href="#step-2" title="Direct link to heading">#</a></h4><p>Check if we could read, write, update, delete in origin consul kv under sync path</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="step-3"></a>Step 3<a aria-hidden="true" tabindex="-1" class="hash-link" href="#step-3" title="Direct link to heading">#</a></h4><p>Check if we could read, write, update, delete in origin vault under data paths specified in config</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="step-4"></a>Step 4<a aria-hidden="true" tabindex="-1" class="hash-link" href="#step-4" title="Direct link to heading">#</a></h4><p>Prepare an error channel through which anyone under sync cycle can contact to throw errors</p><p>We also need to listen to error channel and check if the error at hand is fatal or not.</p><p>If not fatal, log the error with as much context available.
If fatal, stop the current sync cycle cleanly and future cycles. Log the error, inform a human, halt the program.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="step-5"></a>Step 5<a aria-hidden="true" tabindex="-1" class="hash-link" href="#step-5" title="Direct link to heading">#</a></h4><p>Prepare an signal channel through which OS can send halt signals. Useful for humans to stop the whole sync program cleanly stop.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="step-6"></a>Step 6<a aria-hidden="true" tabindex="-1" class="hash-link" href="#step-6" title="Direct link to heading">#</a></h4><p>A ticker is initialized for an interval (default: 1m) to start the sync cycle.
The trigger will be starting point for one cycle.</p><hr><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="cycle"></a>Cycle<a aria-hidden="true" tabindex="-1" class="hash-link" href="#cycle" title="Direct link to heading">#</a></h2><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="step-0"></a>Step 0<a aria-hidden="true" tabindex="-1" class="hash-link" href="#step-0" title="Direct link to heading">#</a></h4><p>A timer with timeout (default: 5m) will be created for every sync cycle. If workers get struck inbetween or something happens we do not halt vsync. Instead we wait till the timeout and kill everything created for current sync cycle. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="step-1-1"></a>Step 1<a aria-hidden="true" tabindex="-1" class="hash-link" href="#step-1-1" title="Direct link to heading">#</a></h4><p>Create a fresh <code>sync info</code> to store vsync metadata. It needs to be safe for concurrent usage.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="step-2-1"></a>Step 2<a aria-hidden="true" tabindex="-1" class="hash-link" href="#step-2-1" title="Direct link to heading">#</a></h4><p>For an interval (default: 1m) we get a list of paths recursively that needs to be synced based on data paths. Example, for datapath <code>secret/</code> we get absolute paths <code>[secret/metadata/stage/app1, secret/metadata/stage/app2]</code></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="step-3-1"></a>Step 3<a aria-hidden="true" tabindex="-1" class="hash-link" href="#step-3-1" title="Direct link to heading">#</a></h4><p>We create multiple worker go routines (default: 1). Each worker will generate insight and save in sync info for a given absolute path.</p><p>Each routine will be given:</p><ul><li>vault client pointing to origin</li><li>shared sync info</li><li>error channel</li><li>multiple absolute paths but one at a time</li></ul><p>sync info needs be safe for concurrent usage</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="step-4-1"></a>Step 4<a aria-hidden="true" tabindex="-1" class="hash-link" href="#step-4-1" title="Direct link to heading">#</a></h4><p>Create 1 go routine to handle saving info to consul</p><ul><li>if cycle is successful, save consul sync info</li><li>if cycle has failed, abort saving info because it will corrupt existing sync info</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="step-5-1"></a>Step 5<a aria-hidden="true" tabindex="-1" class="hash-link" href="#step-5-1" title="Direct link to heading">#</a></h4><p>From the list of absolute paths send one path to next available worker. Once we have sent all the paths, wait for all worker go routines to complete their work.</p><p>The sender needs to be in separate routine, because we need to stop sending work to worker if we get halt signals.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="step-6-1"></a>Step 6<a aria-hidden="true" tabindex="-1" class="hash-link" href="#step-6-1" title="Direct link to heading">#</a></h4><p>Reindex the sync info, for generating index info for each bucket.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="step-7"></a>Step 7<a aria-hidden="true" tabindex="-1" class="hash-link" href="#step-7" title="Direct link to heading">#</a></h4><p>If everything is successful, send save signal for saving info ( index and buckets ) to consul.</p><p>If the cycle is aborted by signal, do not send the save signal for saving.</p><p>We need to cleanly close the cycle. Log appropriate cycle messages.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/ExpediaGroup/vsync/edit/master/website/docs/internals/origin.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/vsync/docs/internals/keywords"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Keywords</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/vsync/docs/internals/destination"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Destination »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#startup" class="table-of-contents__link">Startup</a></li><li><a href="#cycle" class="table-of-contents__link">Cycle</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="text--center"><div>Copyright © 2020 Expedia, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/vsync/styles.eea3d490.js"></script>
<script src="/vsync/runtime~main.ef594e85.js"></script>
<script src="/vsync/main.3dbd1806.js"></script>
<script src="/vsync/1.1056e411.js"></script>
<script src="/vsync/2.0b2ae9c7.js"></script>
<script src="/vsync/19.2e660dd5.js"></script>
<script src="/vsync/20.19d957be.js"></script>
<script src="/vsync/9e5e1161.8c4f2118.js"></script>
<script src="/vsync/17896441.f04f2844.js"></script>
<script src="/vsync/e4a51ca5.a9da0374.js"></script>
</body>
</html>